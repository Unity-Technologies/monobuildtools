use Cwd;
use Cwd 'abs_path';
use Getopt::Long;
use File::Basename;
use File::Path;
use Config;

print ">>> My Path: $ENV{PATH}\n\n";

my $monoroot = File::Spec->rel2abs(dirname(__FILE__) . "/../..");
my $monoroot = abs_path($monoroot);
my $buildScriptsRoot = "$monoroot/external/buildscripts";
print ">>> Mono checkout found in $monoroot\n\n";

my $cygwinRootWindows = "";
my $monoInstallLinux = "";
my $checkoutOnTheFly=0;
my $buildDeps = "";
my $forceDefaultBuildDeps = 0;

my @thisScriptArgs = ();
my @passAlongArgs = ();
foreach my $arg (@ARGV)
{
	push @backupArgs, $arg;
	
	if ($arg =~ /^--cygwin=/)
	{
		push @thisScriptArgs, $arg;
	}
	elsif ($arg =~ /^--existingmono=/)
	{
		push @thisScriptArgs, $arg;
	}
	elsif ($arg =~ /^--checkoutonthefly=/)
	{
		push @thisScriptArgs, $arg;
		push @passAlongArgs, $arg;
	}
	elsif ($arg =~ /^--builddeps=/)
	{
		push @thisScriptArgs, $arg;
		push @passAlongArgs, $arg;
	}
	elsif ($arg =~ /^--forcedefaultbuilddeps=/)
	{
		push @thisScriptArgs, $arg;
		push @passAlongArgs, $arg;
	}
	else
	{
		push @passAlongArgs, $arg;
	}
}

print(">>> This Script Args = @thisScriptArgs\n");
print(">>> Pass Along Args = @passAlongArgs\n");

@ARGV = @thisScriptArgs;
GetOptions(
	'cygwin=s'=>\$cygwinRootWindows,
	'existingmono=s'=>\$monoInstallLinux,
	'checkoutonthefly=i'=>\$checkoutOnTheFly,
	'builddeps=s'=>\$buildDeps,
	'forcedefaultbuilddeps=i'=>\$forceDefaultBuildDeps,
);

my $externalBuildDeps = "";
if ($buildDeps ne "")
{
	$externalBuildDeps = $buildDeps;
}
else
{
	if (-d "$monoroot/external/mono-build-deps" || $forceDefaultBuildDeps)
	{
		$externalBuildDeps = "$monoroot/external/mono-build-deps";
	}
	
	if (!(-d "$externalBuildDeps"))
	{
		if ($checkoutOnTheFly)
		{
			# Check out on the fly
			$externalBuildDeps = "$monoroot/external/mono-build-deps";
			print(">>> Checking out mono build dependencies to : $externalBuildDeps\n");
			my $repo = "https://ono.unity3d.com/unity-extra/mono-build-deps";
			print(">>> Cloning $repo at $externalBuildDeps\n");
			system("hg", "clone", $repo, "$externalBuildDeps") eq 0 or die("failed to checkout mono build dependencies\n");
		}
	}
}

print(">>> externalBuildDeps = $externalBuildDeps\n");

my $SevenZip = "$externalBuildDeps/7z/win64/7za.exe";

# Attempt to find common default cygwin install locations
if ($cygwinRootWindows eq "")
{
	print(">>> No cygwin install specified.  Looking for defaults...\n");
	
	my $externalCygwin = "$externalBuildDeps/cygwin64/builds";
	my $externalCygwinZip = "$externalBuildDeps/cygwin64/builds.zip";
	
	if (-d "$externalCygwin")
	{
		$cygwinRootWindows = $externalCygwin;
		print(">>> Found Cygwin at : $cygwinRootWindows\n");
	}
	elsif(-f "$externalCygwinZip")
	{
		print(">>> Found unextracted cygwin builds.zip : $externalCygwinZip\n");
		print(">>> Using 7z : $SevenZip\n");
		print(">>> Extracting...\n");
		system("$SevenZip", "x", "$externalCygwinZip", "-o$externalBuildDeps/cygwin64") eq 0 or die("Failed extracting cygwin\n");
		$cygwinRootWindows = $externalCygwin;
	}
	else
	{
		if ($forceDefaultBuildDeps)
		{
			die("\nCould not fined Cygwin in default external build deps location : $externalBuildDeps\n")
		}
		else
		{
			if (-d "C:\\Cygwin64")
			{
				$cygwinRootWindows = "C:\\Cygwin64";
				print(">>> Found Cygwin at : $cygwinRootWindows\n");
			}
			elsif (-d "C:\\Cygwin")
			{
				$cygwinRootWindows = "C:\\Cygwin";
				print(">>> Found Cygwin at : $cygwinRootWindows\n");
			}
			else
			{
				die("\nCould not fined Cygwin.  Define path using --cygwin=<path>\n")
			}
		}
	}
}
else
{
	print(">>> Cygwin Path = $cygwinRootWindows\n");
}

if ($monoInstallLinux eq "")
{
	print(">>> No mono install specified.  Looking for defaults...\n");
	
	my $externalMono = "$externalBuildDeps/mono/win/builds";
	my $externalMonoZip = "$externalBuildDeps/mono/win/builds.zip";
	
	if (-d "$externalMono")
	{
		$monoInstallLinux = $externalMono;
		$monoInstallLinux =~ s/\\/\//g;
		print(">>> Found Mono at : $monoInstallLinux\n");
	}
	elsif(-f "$externalMonoZip")
	{
		print(">>> Found unextracted mono builds.zip : $externalMonoZip\n");
		print(">>> Using 7z : $SevenZip\n");
		print(">>> Extracting...\n");
		system("$SevenZip", "x", "$externalMonoZip", "-o$externalBuildDeps/mono/win") eq 0 or die("Failed extracting mono\n");
		$monoInstallLinux = $externalMono;
		$monoInstallLinux =~ s/\\/\//g;
		print(">>> Found Mono at : $monoInstallLinux\n");
	}
	else
	{
		if ($forceDefaultBuildDeps)
		{
			die("\nCould not fined mono in default external build deps location : $externalBuildDeps\n")
		}
		else
		{
			if (-d "C:\\Program Files (x86)\\Mono")
			{
				# Pass over the cygwin format since I already have it escaped correctly to survive
				# crossing over the shell
				$monoInstallLinux = "/cygdrive/c/Program\\ Files\\ \\(x86\\)/Mono";
				print(">>> Found Mono at : $monoInstallLinux\n");
			}
			else
			{
				die("\n--existingmono=<path> is required and should be in the cygwin path format\n");
			}
		}
	}
}
else
{
	$monoInstallLinux =~ s/\\/\//g;
	print(">>> Linux Mono Path = $monoInstallLinux\n");
}

push @passAlongArgs, "--existingmono=$monoInstallLinux" if $monoInstallLinux ne "";

my $windowsPerl = $Config{perlpath};
print ">>> Perl Exe = $windowsPerl\n";
push @passAlongArgs, "--winperl=$windowsPerl";
push @passAlongArgs, "--winmonoroot=$monoroot";

print ">>> Calling $cygwinRootWindows\\bin\\sh.exe with @passAlongArgs";
system("$cygwinRootWindows\\bin\\sh.exe", "$monoroot/external/buildscripts/build_win_wrapper.sh", @passAlongArgs) eq 0 or die("failed building mono\n");